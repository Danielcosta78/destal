<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="../manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('../sw.js')
        .then(() => console.log('Service Worker registrado com sucesso.'))
        .catch(error => console.log('Erro ao registrar Service Worker:', error));
    }
  </script>
  <link rel="icon" href="../icon-192.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Decentralized Chat</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css">
  <style>
    :root {
      --primary-color: #4361ee;
      --primary-dark: #3a0ca3;
      --success-color: #4cc9f0;
      --warning-color: #f8961e;
      --danger-color: #f72585;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --gray-light: #e9ecef;
      --sidebar-width: 300px;
      --mobile-breakpoint: 768px;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
    }

    /* Layout Principal */
    .app-container {
      display: flex;
      height: 100vh;
      position: relative;
    }

    /* Barra Lateral */
    .sidebar {
      width: var(--sidebar-width);
      background: white;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
      position: fixed;
      height: 100vh;
      z-index: 100;
      transition: transform 0.3s ease;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      transform: translateX(-100%);
    }

    .sidebar.open {
      transform: translateX(0);
    }

    /* Cabeçalho do Sidebar */
    .sidebar-header {
      display: flex;
      height: 60px;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid var(--gray-light);
      background: var(--primary-color);
      color: white;
      flex-shrink: 0;
      width: 100%;
    }

    .sidebar-header h5 {
      margin: 0;
      font-weight: 600;
    }

    .close-sidebar {
      background: none;
      border: none;
      font-size: 1.25rem;
      color: white;
      cursor: pointer;
      display: block;
      padding: 5px;
    }

    /* Conteúdo rolável da sidebar */
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
    }

  

    /* Navbar */
    .navbar {
      width: 100%;
      height: 60px;
      background: var(--primary-color);
      padding: 15px;
      position: sticky;
      top: 0;
      z-index: 90;
    }

    .navbar-brand {
      font-weight: 600;
      color: white !important;
      display: flex;
      align-items: center;
    }

    .navbar-brand i {
      margin-right: 10px;
    }

    /* Botão para abrir sidebar */
    .sidebar-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 1.25rem;
      margin-right: 15px;
      display: block;
      cursor: pointer;
    }



    .message-header {
      padding: 15px;
      border-bottom: 1px solid var(--gray-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    /* Substitua estas regras existentes */
.message-container {
  flex: 1;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  border: 1px solid var(--gray-light);
  display: flex;
  flex-direction: column;
  margin: 15px;
  min-height: 0; /* Adicione esta linha */
  height: 100vh; /* Ajuste conforme necessário */
}

/* Ajuste a área de mensagens */
#messageBox {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
  background-color: #fafafa;
  min-height: 0;
}

/* Ajuste o container principal */
.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  height: 93vh;
}

/* Ajuste o container das mensagens */
.container-fluid.p-0 {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  height: calc(100% - 60px); /* Subtrai a altura da navbar */
}

@media (max-width: 768px) {
  .message-container {
    height: calc(100vh - 140px); /* Mais espaço para mobile */
    margin: 10px;
  }
}

    /* Input de Mensagem */
    .message-input-container {
      padding: 15px;
      background: white;
      border-top: 1px solid var(--gray-light);
      flex-shrink: 0;
    }

    /* Estilos para mensagens */
    .message {
      margin: 8px 0;
      padding: 10px 15px;
      border-radius: 8px;
      word-break: break-word;
      max-width: 80%;
      position: relative;
    }

    .user-message {
      background-color: #e9f5ff;
      border-left: 3px solid var(--primary-color);
      margin-left: auto;
    }

    .peer-message {
      background-color: white;
      border-left: 3px solid var(--gray-light);
    }

    .timestamp {
      font-size: 0.75rem;
      color: #6c757d;
      display: block;
      margin-bottom: 5px;
    }

    .message-author {
      font-weight: 500;
      margin-bottom: 5px;
    }

    .user-message .message-author {
      color: var(--primary-dark);
    }

    .peer-message .message-author {
      color: var(--dark-color);
    }

    /* Sidebar Sections */
    .sidebar-section {
      padding: 15px;
      border-bottom: 1px solid var(--gray-light);
      flex-shrink: 0;
    }

    .sidebar-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--dark-color);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    .sidebar-title i {
      margin-right: 10px;
      color: var(--primary-color);
      transition: transform 0.2s;
    }

    .sidebar-title.collapsed i.fa-chevron-down {
      transform: rotate(-90deg);
    }

    .collapsible-content {
      overflow: hidden;
      transition: max-height 0.3s ease;
      max-height: 0;
    }

    .collapsed + .collapsible-content {
      max-height: 0 !important;
    }

    /* Status */
    .status-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 15px;
      background: rgba(0,0,0,0.03);
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .status-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 50px;
    }

    .badge-connected {
      background-color: rgba(67, 97, 238, 0.1);
      color: var(--primary-color);
    }

    .badge-disconnected {
      background-color: rgba(248, 37, 133, 0.1);
      color: var(--danger-color);
    }

    .badge-ready {
      background-color: rgba(76, 201, 240, 0.1);
      color: var(--success-color);
    }

    .status-icon {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-left: 8px;
    }

    .icon-connected {
      background-color: var(--primary-color);
    }

    .icon-disconnected {
      background-color: var(--danger-color);
    }

    .icon-ready {
      background-color: var(--success-color);
    }

    /* Listas de Contatos e IDs */
    .contact-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .contact-item {
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 5px;
      transition: all 0.2s ease;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .contact-item:hover {
      background-color: rgba(0,0,0,0.03);
    }

    .contact-item.active {
      background-color: rgba(67, 97, 238, 0.1);
    }

    .contact-info {
      flex: 1;
      min-width: 0;
    }

    .contact-name {
      font-weight: 500;
      color: var(--dark-color);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .contact-id {
      font-size: 0.75rem;
      color: #6c757d;
      font-family: 'Courier New', Courier, monospace;
      word-break: break-all;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Botões de Ação */
    .action-btn {
      background: none;
      border: none;
      color: #6c757d;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 5px;
      margin-left: 5px;
    }

    .action-btn:hover {
      color: var(--primary-color);
    }

    .connect-btn:hover {
      color: var(--success-color);
    }

    .delete-btn:hover {
      color: var(--danger-color);
    }

    /* Formulários */
    .form-group-sm label {
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
    }

    /* Botão de Instalação */
    #install-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--primary-color);
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      z-index: 1000;
      display: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    /* Overlay para mobile */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99;
      display: none;
    }

    .sidebar-overlay.show {
      display: block;
    }

    /* Scrollbar personalizada */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    /* Botão de limpar IDs */
    .clear-btn {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }

    @media (min-width: 769px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .sidebar-overlay {
        display: none !important;
      }
      .main-content {
        margin-left: 0;
      }
      .sidebar-toggle {
        display: block;
      }
      .close-sidebar {
        display: block;
      }
    }
    
    .connection-status-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background-color: #6c757d; /* Cor padrão (cinza) */
  margin-left: 10px;
  transition: all 0.3s ease;
}

.connection-status-dot.connected {
  background-color: #4cc9f0; /* Cor quando conectado */
  box-shadow: 0 0 8px rgba(76, 201, 240, 0.6);
}

.connection-status-dot.disconnected {
  background-color: #f72585; /* Cor quando desconectado */
}

.connection-status-dot.ready {
  background-color: #FFFF00; /* Cor quando pronto para conectar */
  box-shadow: 0 0 8px rgba(67, 97, 238, 0.6);
}
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Barra Lateral -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h5><i class="fas fa-comments mr-2"></i>Menu</h5>
        <button class="close-sidebar" id="closeSidebar">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="sidebar-content">
        <!-- Seção de Status -->
        <div class="sidebar-section">
          <div class="status-container">
            <div>
              <span id="status" class="status-badge badge-disconnected">Disconnected</span>
              <span id="status-icon" class="status-icon icon-disconnected"></span>
            </div>
            <button id="reconnectButton" class="btn btn-sm btn-outline-primary">
              <i class="fas fa-power-off"></i>
            </button>
          </div>
        </div>

        <!-- Seção de Identidade -->
        <div class="sidebar-section">
          <h5 class="sidebar-title"><i class="fas fa-user"></i> My Identity</h5>
          <div class="form-group form-group-sm">
            <label>ID:</label>
            <div class="input-group mb-2">
              <input id="uid" type="text" class="form-control form-control-sm" placeholder="Enter or generate">
              <div class="input-group-append">
                <button id="generateId" class="btn btn-outline-secondary btn-sm" title="Generate random ID">
                  <i class="fas fa-random"></i>
                </button>
                <button id="copyGeneratedId" class="btn btn-outline-primary btn-sm" title="Copy ID">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
          </div>
          <div class="form-group form-group-sm">
            <label>Display Name:</label>
            <input id="myIdName" type="text" class="form-control form-control-sm" placeholder="Your name">
          </div>
        </div>

        <!-- Seção de Conexão -->
        <div class="sidebar-section">
          <h5 class="sidebar-title"><i class="fas fa-link"></i> Connect to Peer</h5>
          <div class="form-group form-group-sm">
            <label>Peer ID:</label>
            <div class="input-group mb-2">
              <input id="rid" type="text" class="form-control form-control-sm" placeholder="ID to connect">
              <div class="input-group-append">
                <button id="rid-button" class="btn btn-primary btn-sm">
                  <i class="fas fa-link"></i>
                </button>
              </div>
            </div>
          </div>
          <div class="form-group form-group-sm">
            <label>Save as Contact:</label>
            <div class="input-group">
              <input id="contactName" type="text" class="form-control form-control-sm" placeholder="Contact name">
              <div class="input-group-append">
                <button id="saveContact" class="btn btn-success btn-sm">
                  <i class="fas fa-save"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Seção de Contatos (recolhível) -->
        <div class="sidebar-section">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="sidebar-title collapsed" id="contactsTitle"><i class="fas fa-chevron-down"></i><i class="fas fa-users ml-2"></i> Contacts</h5>
            <button class="btn btn-sm btn-outline-danger clear-btn" id="clearAllContacts">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
          <div class="collapsible-content" id="contactsContent">
            <ul id="contactsList" class="contact-list"></ul>
          </div>
        </div>

        <!-- Seção de Meus IDs (recolhível) -->
        <div class="sidebar-section">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="sidebar-title collapsed" id="myIdsTitle"><i class="fas fa-chevron-down"></i><i class="fas fa-id-card ml-2"></i> My IDs</h5>
            <button class="btn btn-sm btn-outline-danger clear-btn" id="clearAllIds">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
          <div class="collapsible-content" id="myIdsContent">
            <ul id="myIdsList" class="contact-list"></ul>
          </div>
        </div>
         <p>&nbsp;</p>
          <p>&nbsp;</p>
          <p>&nbsp;</p>
      </div>
    </div>

    <!-- Conteúdo Principal -->
    <div class="main-content">
      <!-- Navbar -->
      <nav class="navbar navbar-expand navbar-light">
        <button class="sidebar-toggle" id="sidebarToggle">
          <i class="fas fa-bars"></i>
        </button>
        <a class="navbar-brand">
          <i class="fas fa-comments"></i>Destal &nbsp;<small>Decentralized Chat</small>
        </a>
        <div class="ml-auto d-flex align-items-center">
  <div id="connectionStatus" class="connection-status-dot"></div>
</div>
      </nav>

      <!-- Área de Mensagens -->
      <div class="container-fluid p-0">
        <div class="message-container">
          <div class="message-header">
            <h5 class="mb-0"><i class="fas fa-comments mr-2" style="color: var(--primary-color);"></i>Messages</h5>
          </div>
          <div id="messageBox"></div>
          <div class="message-input-container">
            <div class="input-group">
              <input id="messageText" type="text" class="form-control" placeholder="Type your message..." autofocus>
              <div class="input-group-append">
                <button id="messageSend" class="btn btn-primary">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Overlay para mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
  </div>

  <!-- Botão de Instalação -->
  <button id="install-btn">Install App</button>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script>
  $(document).ready(function () {
    let peer = null, conn = null, last_peer = null;
    let currentContact = null;

    // Controle do menu lateral
    function openSidebar() {
      $('#sidebar').addClass('open');
      $('#sidebarOverlay').addClass('show');
      $('body').css('overflow', 'hidden');
    }

    function closeSidebar() {
      $('#sidebar').removeClass('open');
      $('#sidebarOverlay').removeClass('show');
      $('body').css('overflow', '');
    }

    // Eventos para abrir/fechar o menu
    $('#sidebarToggle').click(openSidebar);
    $('#closeSidebar').click(closeSidebar);
    $('#sidebarOverlay').click(closeSidebar);

    // Controle das seções recolhíveis
    $('#contactsTitle').click(function() {
      $(this).toggleClass('collapsed');
      $('#contactsContent').css('max-height', $(this).hasClass('collapsed') ? '0' : $('#contactsList').height() + 'px');
    });

    $('#myIdsTitle').click(function() {
      $(this).toggleClass('collapsed');
      $('#myIdsContent').css('max-height', $(this).hasClass('collapsed') ? '0' : $('#myIdsList').height() + 'px');
    });

    // Atualizar status
function setStatus(text, color, statusClass) {
  $('#status').text(text);
  $('#status-icon').removeClass('icon-connected icon-ready icon-disconnected').addClass('icon-' + color);
  $('#status').removeClass('badge-connected badge-ready badge-disconnected').addClass(statusClass);
  
  // Atualiza a bolinha de status na navbar
  const $statusDot = $('#connectionStatus');
  $statusDot.removeClass('connected disconnected ready');
  
  if (text === 'Connected') {
    $statusDot.addClass('connected');
  } else if (text === 'Ready to connect') {
    $statusDot.addClass('ready');
  } else {
    $statusDot.addClass('disconnected');
  }
}

    // Obter timestamp formatado
    function getTimestamp(ms) {
      const d = new Date(ms);
      return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
    }

    // Adicionar mensagem ao chat
    function addMessage(msg) {
      const isCurrentUser = msg.author === peer?.id;
      const authorName = isCurrentUser ? 
        'You' : 
        (msg.authorName || msg.author.substring(0, 8));
      
      const messageType = msg.type === 'info' ? 'info-message' : 'text-message';
      
      const messageHTML = `
        <div class="message ${isCurrentUser ? 'user-message' : 'peer-message'} ${messageType}">
          <span class="timestamp">${getTimestamp(msg.timestamp)}</span>
          <div class="message-author">${authorName}</div>
          ${msg.type === 'info' ? 'connected' : msg.content}
        </div>
      `;
      
      $('#messageBox').append(messageHTML);
      $('#messageBox').scrollTop($('#messageBox')[0].scrollHeight);
    }

    // Criar objeto de mensagem
    function createMessage(content) {
      return { 
        author: peer?.id, 
        authorName: $('#myIdName').val().trim() || peer?.id.substring(0, 8),
        timestamp: Date.now(), 
        content,
        type: 'message'
      };
    }

    // Configurar conexão
    function ready() {
      conn.on('open', () => {
        setStatus('Connected', 'connected', 'badge-connected');
        $('#rid').val(conn.peer);
        
        // Enviar mensagem de info
        conn.send({
          type: 'info',
          author: peer.id,
          authorName: $('#myIdName').val().trim() || peer.id.substring(0, 8),
          timestamp: Date.now()
        });

        // Atualizar contato ativo
        const contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
        currentContact = contacts.find(c => c.id === conn.peer);
        updateContactsList();
      });

      conn.on('data', (data) => {
        addMessage(data);
      });
      
      conn.on('close', () => {
        conn = null;
        currentContact = null;
        setStatus('Connection closed', 'disconnected', 'badge-disconnected');
        updateContactsList();
      });
    }

    // Inicializar Peer
    function initialize() {
      const customId = $('#uid').val().trim();
      peer = customId ? new Peer(customId) : new Peer();

      peer.on('open', id => {
        $('#uid').val(id);
        last_peer = id;
        setStatus('Ready to connect', 'ready', 'badge-ready');
        saveMyId(id, $('#myIdName').val().trim() || `My ID ${id.substring(0, 4)}`);
      });

      peer.on('connection', c => {
        if (conn) { 
          c.close(); 
          return; 
        }
        conn = c;
        ready();
      });

      peer.on('disconnected', () => {
        setStatus('Disconnected', 'disconnected', 'badge-disconnected');
        peer.id = last_peer;
        peer.reconnect();
      });

      peer.on('close', () => {
        conn = null;
        setStatus('Client closed', 'disconnected', 'badge-disconnected');
      });

      peer.on('error', err => {
        console.error('PeerJS Error:', err);
        setStatus('Error: ' + err.type, 'disconnected', 'badge-disconnected');
        alert('PeerJS Error: ' + err.message);
      });
    }

    // Gerar ID aleatório
    $('#generateId').click(() => {
      const randomId = 'user-' + Math.random().toString(36).substring(2, 10);
      $('#uid').val(randomId);
      $('#myIdName').val(`User ${randomId.substring(5, 9)}`);
      showCopiedFeedback($('#copyGeneratedId'));
    });

    // Copiar ID gerado
    $('#copyGeneratedId').click(function() {
      const id = $('#uid').val().trim();
      if (id) {
        copyToClipboard(id, $(this));
      } else {
        alert('No ID to copy');
      }
    });

    // Iniciar conexão Peer
    $('#reconnectButton').click(initialize);

    // Conectar a um peer
    $('#rid-button').click(() => {
      if (conn) conn.close();
      const id = $('#rid').val().trim();
      if (!id) return alert('Enter a Peer ID');
      conn = peer.connect(id, { reliable: true });
      setStatus('Connecting...', 'disconnected', 'badge-disconnected');
      ready();
    });

    // Enviar mensagem
    $('#messageSend').click(() => {
      const text = $('#messageText').val().trim();
      if (!text) return;
      const msg = createMessage(text);
      if (conn?.open) {
        conn.send(msg);
        addMessage(msg);
        $('#messageText').val('').focus();
      } else {
        alert('Not connected to any peer');
      }
    });

    // Enviar mensagem com Enter
    $('#messageText').keypress(e => e.which === 13 && $('#messageSend').click());

    // Salvar contato
    $('#saveContact').click(() => {
      const name = $('#contactName').val().trim();
      const id = $('#rid').val().trim();
      if (!name) return alert('Enter contact name');
      if (!id) return alert('Enter peer ID');
      
      const contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
      const existingContact = contacts.find(c => c.id === id);
      
      if (existingContact) {
        existingContact.name = name;
      } else {
        contacts.push({ name, id });
      }
      
      localStorage.setItem('contacts', JSON.stringify(contacts));
      updateContactsList();
      $('#contactName').val('');
    });

    // Salvar meu ID
    function saveMyId(id, name) {
      const ids = JSON.parse(localStorage.getItem('myids') || '[]');
      const existingId = ids.find(i => i.id === id);
      
      if (existingId) {
        existingId.name = name;
      } else {
        ids.push({ id, name });
      }
      
      localStorage.setItem('myids', JSON.stringify(ids));
      updateMyIdsList();
    }

    // Atualizar lista de IDs
    function updateMyIdsList() {
      const ids = JSON.parse(localStorage.getItem('myids') || '[]');
      $('#myIdsList').html(ids.map(i => 
        `<li class="contact-item ${peer?.id === i.id ? 'active' : ''}" data-id="${i.id}">
          <div class="contact-info" onclick="$('#uid').val('${i.id}'); $('#myIdName').val('${i.name.replace(/'/g, "\\'")}')">
            <div class="contact-name">${i.name}</div>
            <div class="contact-id">${i.id}</div>
          </div>
          <div>
            <button class="action-btn connect-btn" onclick="$('#uid').val('${i.id}'); $('#myIdName').val('${i.name.replace(/'/g, "\\'")}')" title="Use this ID">
              <i class="fas fa-check"></i>
            </button>
            <button class="action-btn copy-btn" data-id="${i.id}" title="Copy ID">
              <i class="fas fa-copy"></i>
            </button>
            <button class="action-btn delete-btn" onclick="deleteMyId('${i.id.replace(/'/g, "\\'")}')" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </li>`
      ).join('') || '<li class="text-muted p-2">No saved IDs</li>');
    }

    // Atualizar lista de contatos
    function updateContactsList() {
      const contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
      $('#contactsList').html(contacts.map(c => 
        `<li class="contact-item ${currentContact?.id === c.id ? 'active' : ''}" data-id="${c.id}">
          <div class="contact-info" onclick="$('#rid').val('${c.id}'); $('#contactName').val('${c.name.replace(/'/g, "\\'")}')">
            <div class="contact-name">${c.name}</div>
            <div class="contact-id">${c.id}</div>
          </div>
          <div>
            <button class="action-btn connect-btn" onclick="$('#rid').val('${c.id}')" title="Connect to this peer">
              <i class="fas fa-link"></i>
            </button>
            <button class="action-btn copy-btn" data-id="${c.id}" title="Copy ID">
              <i class="fas fa-copy"></i>
            </button>
            <button class="action-btn delete-btn" onclick="deleteContact('${c.id.replace(/'/g, "\\'")}')" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </li>`
      ).join('') || '<li class="text-muted p-2">No contacts saved</li>');
    }

    // Deletar meu ID
    window.deleteMyId = function(id) {
      if (confirm('Are you sure you want to delete this ID?')) {
        let ids = JSON.parse(localStorage.getItem('myids') || '[]');
        ids = ids.filter(i => i.id !== id);
        localStorage.setItem('myids', JSON.stringify(ids));
        updateMyIdsList();
        
        if (peer?.id === id) {
          peer.destroy();
          peer = null;
          setStatus('Disconnected', 'disconnected', 'badge-disconnected');
        }
      }
    }

    // Deletar contato
    window.deleteContact = function(id) {
      if (confirm('Are you sure you want to delete this contact?')) {
        let contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
        contacts = contacts.filter(c => c.id !== id);
        localStorage.setItem('contacts', JSON.stringify(contacts));
        updateContactsList();
        
        if (currentContact?.id === id) {
          if (conn) conn.close();
          currentContact = null;
        }
      }
    }

    // Copiar para área de transferência
    window.copyToClipboard = function(text, $element) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          showCopiedFeedback($element);
        }).catch(err => {
          fallbackCopy(text, $element);
        });
      } else {
        fallbackCopy(text, $element);
      }
    }

    // Fallback para copiar
    function fallbackCopy(text, $element) {
      try {
        const $temp = $('<textarea>').val(text).appendTo('body').select();
        const success = document.execCommand('copy');
        $temp.remove();
        if (success) {
          showCopiedFeedback($element);
        } else {
          alert('Failed to copy text. Please copy manually: ' + text);
        }
      } catch (err) {
        alert('Failed to copy text. Please copy manually: ' + text);
      }
    }

    // Mostrar feedback de cópia
    function showCopiedFeedback($element) {
      const originalHtml = $element.html();
      $element.html('<i class="fas fa-check"></i>');
      setTimeout(() => {
        $element.html(originalHtml);
      }, 1000);
    }

    // Limpar todos os IDs
    $('#clearAllIds').click(function() {
      if (confirm('Are you sure you want to delete all your IDs?')) {
        localStorage.removeItem('myids');
        updateMyIdsList();
        $('#uid').val('');
        $('#myIdName').val('');
        if (peer) {
          peer.destroy();
          peer = null;
          setStatus('Disconnected', 'disconnected', 'badge-disconnected');
        }
      }
    });

    // Limpar todos os contatos
    $('#clearAllContacts').click(function() {
      if (confirm('Are you sure you want to delete all contacts?')) {
        localStorage.removeItem('contacts');
        updateContactsList();
        $('#rid').val('');
        $('#contactName').val('');
        if (conn) {
          conn.close();
          conn = null;
          currentContact = null;
        }
      }
    });

    // Delegar eventos para botões de cópia
    $('#myIdsList, #contactsList').on('click', '.copy-btn', function() {
      const id = $(this).data('id');
      if (id) {
        copyToClipboard(id, $(this));
      } else {
        alert('No ID to copy');
      }
    });

    // Inicializar UI
    updateMyIdsList();
    updateContactsList();
  });

  // PWA Installation
  let deferredPrompt;
  const installBtn = document.getElementById('install-btn');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'block';
  });

  installBtn.addEventListener('click', () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(choiceResult => {
        if (choiceResult.outcome === 'accepted') {
          console.log('App installed');
        }
        deferredPrompt = null;
        installBtn.style.display = 'none';
      });
    }
  });
  </script>
</body>
</html>
